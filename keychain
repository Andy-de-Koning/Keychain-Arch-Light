#!/bin/bash
# Eigen Keychain-light voor Arch/Hyprland
KEYDIR="$HOME/.keychain"
mkdir -p "$KEYDIR"
ENV_FILE="$KEYDIR/${HOSTNAME:-archlinux}-env"

start_agent() {
  [ -f "$ENV_FILE" ] && source "$ENV_FILE" >/dev/null
  if [ -z "$SSH_AGENT_PID" ] || ! kill -0 "$SSH_AGENT_PID" 2>/dev/null; then
    ssh-agent -s | grep -v "Agent pid" >"$ENV_FILE"
    source "$ENV_FILE" >/dev/null
  fi
}

DO_EVAL=false
KEYS=()
while [[ $# -gt 0 ]]; do
  case $1 in
  --eval)
    DO_EVAL=true
    shift
    ;;
  --agents)
    shift
    shift
    ;; # skip --agents + ssh
  *)
    KEYS+=("$1")
    shift
    ;;
  esac
done

start_agent
for key in "${KEYS[@]}"; do
  if ! ssh-add -l >/dev/null 2>&1; then
    for key in "${KEYS[@]}"; do
      ssh-add "$HOME/.ssh/$key" 2>/dev/null
    done
  fi
done

if [ "$DO_EVAL" = true ]; then
  grep -E 'SSH_AUTH_SOCK|SSH_AGENT_PID' "$ENV_FILE"
fi
